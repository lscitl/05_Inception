version: "3.8"

services:
  mariadb:
    container_name: mariadb

    build:
      context: ./requirements/mariadb
      dockerfile: ./Dockerfile
      args:
        - MARIADB_ADMIN
        - MARIADB_ADMIN_PW
        - MARIADB_USER
        - MARIADB_USER_PW
        - MARIADB_NAME

    restart: always

    volumes:
      - v_wpdb:/var/lib/mysql

    networks:
      nw-db:
        aliases:
          - mariadb

    env_file:
      - .env

  wordpress:
    container_name: wordpress

    build:
      context: ./requirements/wordpress
      dockerfile: ./Dockerfile
      args:
        - WP_PATH
        - WP_URL
        - WP_TITLE
        - WP_ADMIN
        - WP_ADMIN_PW
        - WP_ADMIN_EMAIL
        - WP_USER
        - WP_USER_PW
        - WP_USER_EMAIL
        - MARIADB_ADMIN
        - MARIADB_ADMIN_PW
        - MARIADB_USER
        - MARIADB_USER_PW
        - MARIADB_NAME
        - MARIADB_CONTAINER_NAME
        - FTP_HOST
        - FTP_USER
        - FTP_PASS
        - REDIS_HOST
        - REDIS_PORT

    restart: always

    volumes:
      - v_wp:${WP_PATH}

    networks:
      nw-db: {}
      nw-redis: {}
      nw-ftp: {}
      nw-nginx:
        aliases:
          - wordpress

    env_file:
      - .env

    depends_on:
      mariadb:
        condition: service_healthy
      # redis:
      #   condition: service_started


  nginx:
    container_name: nginx

    build:
      context: ./requirements/nginx
      dockerfile: ./Dockerfile
      args:
        - SSL_PATH
        - DOMAIN_NAME
        - EMAIL

    restart: always

    ports:
      - "443:443"
      - "4433:4433"

    volumes:
      - v_wp:/var/www/html

    networks:
      nw-nginx:
        aliases:
          - nginx

    environment:
      - .env

    depends_on:
      wordpress:
        condition: service_healthy


  redis:
    container_name: redis

    build:
      context: ./requirements/bonus/redis
      dockerfile: ./Dockerfile

    restart: always

    networks:
      nw-redis:
        aliases:
          - redis

    depends_on:
      wordpress:
        condition: service_healthy


  vsftpd:
    container_name: vsftpd

    build:
      context: ./requirements/bonus/vsftpd
      dockerfile: ./Dockerfile
      args:
        - FTP_SSL_PATH
        - FTP_DOMAIN_NAME
        - EMAIL

    restart: always

    ports:
      - "20:20"
      - "21:21"
      - "2100-2110:2100-2110"

    volumes:
      - v_wp:/var/ftp

    networks:
      nw-ftp:
        aliases:
          - ftp

    env_file:
      - .env


  git:
    container_name: git

    build:
      context: ./requirements/bonus/git
      dockerfile: ./Dockerfile

    restart: always

    ports:
      - "22:22"


networks:
  nw-db:
    driver: bridge
  nw-nginx:
    driver: bridge
  nw-redis:
    driver: bridge
  nw-ftp:
    driver: bridge

volumes:
  v_wpdb:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/wpdb

  v_wp:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH}/wp
